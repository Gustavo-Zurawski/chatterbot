FROM python:3.8-slim-buster

ARG BUILD_VERSION
ARG RABBIT_HOST
ARG RABBIT_USER
ARG RABBIT_VIRTUAL_HOST
ARG RABBIT_NODE_PORT
ARG RABBIT_PASS
ARG ELASTICSEARCH_HOST
ARG ELASTICSEARCH_PORT
ARG ELASTICSEARCH_USE_SSL
ARG ELASTICSEARCH_SCHEMA
ARG REDIS_HOST
ARG REDIS_PORT
ARG REDIS_HOST_CELERY_BACKEND_DB
ARG REDIS_HOST_CACHE_BACKEND_DB
ARG DATABASE_USER
ARG DATABASE_PASSWORD
ARG DATABASE_HOST
ARG DATABASE_PORT
ARG DATABASE_TEST
ARG DATABASE_NAME
ARG DATABASE_SCHEMA
ARG DATABASE_MC_HOST
ARG DATABASE_MC_USER
ARG DATABASE_MC_PASSWORD
ARG DATABASE_MC_PORT
ARG DATABASE_MC_NAME
ARG NEW_RELIC_ENVIRONMENT
ARG AWS_S3_SECURE_BUCKET
ARG AWS_S3_SECRET_ACCESS_KEY
ARG AWS_S3_ACCESS_KEY_ID
ARG AWS_S3_ENVIRONMENT
ARG USE_S3
ARG API_SECRET_KEY
ARG AUTHENTICATION_API_URL
ARG ACCESS_CONTROL_API_URL
ARG MINHA_CONTA_API_ADMIN_URL
ARG MINHA_CONTA_API_PUBLIC_URL
ARG MINHA_CONTA_API_CACHE_TIMEOUT
ARG BACKOFFICE_AUTHENTICATION_API_URL
ARG BACKOFFICE_AUTHENTICATION_API_AUDIENCE
ARG BACKOFFICE_AUTHENTICATION_EXPIRES_TOKEN
ARG ANBIMA_AUTH_URI
ARG ANBIMA_API_URL
ARG ANBIMA_CLIENT_ID
ARG ANBIMA_CLIENT_SECRET


ENV BUILD_VERSION=$BUILD_VERSION \
RABBIT_HOST=$RABBIT_HOST \
RABBIT_USER=$RABBIT_USER \
RABBIT_PASS=$RABBIT_PASS \
RABBIT_NODE_PORT=$RABBIT_NODE_PORT \
RABBIT_VIRTUAL_HOST=$RABBIT_VIRTUAL_HOST \
ELASTICSEARCH_HOST=$ELASTICSEARCH_HOST \
ELASTICSEARCH_PORT=$ELASTICSEARCH_PORT \
ELASTICSEARCH_USE_SSL=$ELASTICSEARCH_USE_SSL \
ELASTICSEARCH_SCHEMA=$ELASTICSEARCH_SCHEMA \
DATABASE_USER=$DATABASE_USER \
DATABASE_PASSWORD=$DATABASE_PASSWORD \
DATABASE_HOST=$DATABASE_HOST \
DATABASE_PORT=$DATABASE_PORT \
DATABASE_TEST=$DATABASE_TEST \
DATABASE_NAME=$DATABASE_NAME \
DATABASE_SCHEMA=$DATABASE_SCHEMA \
DATABASE_MC_HOST=$DATABASE_MC_HOST \
DATABASE_MC_USER=$DATABASE_MC_USER \
DATABASE_MC_PASSWORD=$DATABASE_MC_PASSWORD \
DATABASE_MC_PORT=$DATABASE_MC_PORT \
DATABASE_MC_NAME=$DATABASE_MC_NAME \
AWS_S3_SECRET_ACCESS_KEY=$AWS_S3_SECRET_ACCESS_KEY \
AWS_S3_ACCESS_KEY_ID=$AWS_S3_ACCESS_KEY_ID \
AWS_S3_ENVIRONMENT=$AWS_S3_ENVIRONMENT \
TZ=America/Sao_Paulo \
NEW_RELIC_CONFIG_FILE='./chatterbot/newrelic.ini' \
NEW_RELIC_ENVIRONMENT=$NEW_RELIC_ENVIRONMENT \
AWS_S3_SECURE_BUCKET=$AWS_S3_SECURE_BUCKET \
REDIS_HOST=$REDIS_HOST \
REDIS_PORT=$REDIS_PORT \
REDIS_HOST_CELERY_BACKEND_DB=$REDIS_HOST_CELERY_BACKEND_DB \
REDIS_HOST_CACHE_BACKEND_DB=$REDIS_HOST_CACHE_BACKEND_DB \
USE_S3=$USE_S3 \
API_SECRET_KEY=$API_SECRET_KEY \
AUTHENTICATION_API_URL=$AUTHENTICATION_API_URL \
ACCESS_CONTROL_API_URL=$ACCESS_CONTROL_API_URL \
MINHA_CONTA_API_ADMIN_URL=$MINHA_CONTA_API_ADMIN_URL \
MINHA_CONTA_API_PUBLIC_URL=$MINHA_CONTA_API_PUBLIC_URL \
MINHA_CONTA_API_CACHE_TIMEOUT=$MINHA_CONTA_API_CACHE_TIMEOUT \
BACKOFFICE_AUTHENTICATION_API_URL=$BACKOFFICE_AUTHENTICATION_API_URL \
BACKOFFICE_AUTHENTICATION_API_AUDIENCE=$BACKOFFICE_AUTHENTICATION_API_AUDIENCE \
BACKOFFICE_AUTHENTICATION_EXPIRES_TOKEN=$BACKOFFICE_AUTHENTICATION_EXPIRES_TOKEN \
ANBIMA_AUTH_URI=$ANBIMA_AUTH_URI \
ANBIMA_API_URL=$ANBIMA_API_URL \
ANBIMA_CLIENT_ID=$ANBIMA_CLIENT_ID \
ANBIMA_CLIENT_SECRET=$ANBIMA_CLIENT_SECRET

RUN apt-get update &&\
 apt-get install -y make g++ gcc libpq-dev default-libmysqlclient-dev\
 && apt-get install -y unixodbc-dev\
 && rm -rf /var/lib/apt/lists/*

RUN pip install --no-cache-dir -U pip "pipenv==2018.11.26"

COPY Pipfile Pipfile.lock ./

RUN pipenv install --system

COPY . .

EXPOSE 8000

CMD ['python', 'manage.py', 'check']
# CMD uvicorn renda_fixa.asgi:application --lifespan off --workers=8 --interface asgi3
